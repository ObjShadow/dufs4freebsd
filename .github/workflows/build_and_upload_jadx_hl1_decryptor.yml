on:
  workflow_dispatch:

name: build_and_upload_jadx_hl1_decryptor

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
      
    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Create directory structure
      run: |
        mkdir -p src/main/java/jadx/plugins/decryptstrings
        
    - name: Write plugin source code
      run: |
        cat > src/main/java/jadx/plugins/decryptstrings/StringDecryptPlugin.java << 'EOF'
package jadx.plugins.decryptstrings;

import jadx.api.plugins.JadxPlugin;
import jadx.api.plugins.JadxPluginContext;
import jadx.api.plugins.JadxPluginInfo;
import jadx.api.plugins.options.JadxPluginOptions;
import jadx.core.dex.info.MethodInfo;
import jadx.core.dex.instructions.args.InsnArg;
import jadx.core.dex.nodes.InsnNode;
import jadx.core.dex.nodes.MethodNode;
import jadx.core.dex.attributes.AFlag;
import jadx.core.dex.attributes.AType;
import jadx.core.utils.android.AndroidResourcesUtils;
import jadx.core.utils.exceptions.JadxRuntimeException;

import java.nio.charset.StandardCharsets;
import java.util.Base64;
import java.util.List;

/**
 * 字符串解密插件 - 自动解密 defpackage.hl1.a() 调用
 */
public class StringDecryptPlugin implements JadxPlugin {

    @Override
    public JadxPluginInfo getInfo() {
        return new JadxPluginInfo(
            "string-decrypt",
            "String Decrypt Plugin",
            "Automatically decrypts defpackage.hl1.a() calls and adds comments"
        );
    }

    @Override
    public void init(JadxPluginContext context) {
        // 注册处理过程
        context.getCodeWriter().processCode(codeWriter -> {
            // 实现插件功能
        });
    }

    @Override
    public void init(JadxPluginOptions options) {
        // 处理插件选项
    }
    
    /**
     * 执行与 defpackage.hl1 相同的解密逻辑
     */
    public static String decryptHl1Call(String encodedStr, String keyStr) {
        try {
            // 解码两个输入参数（Base64解码）
            byte[] decodedStr = base64Decode(encodedStr);
            byte[] decodedKey = base64Decode(keyStr);
            
            // 实现 il1.b 方法的异或逻辑
            byte[] result = xorBytes(decodedStr, decodedKey);
            
            return new String(result, StandardCharsets.UTF_8);
        } catch (Exception e) {
            return "DECRYPTION_FAILED: " + e.getMessage();
        }
    }
    
    private static byte[] base64Decode(String input) {
        try {
            // 尝试使用标准 Java Base64 解码
            return Base64.getDecoder().decode(input);
        } catch (Exception e) {
            // 如果失败，可能需要其他解码方式
            throw new RuntimeException("Base64 decode failed", e);
        }
    }
    
    private static byte[] xorBytes(byte[] data, byte[] key) {
        int dataLen = data.length;
        int keyLen = key.length;
        byte[] result = data.clone();
        
        for (int i = 0; i < dataLen; i++) {
            int keyIndex = i % keyLen;
            result[i] = (byte) (result[i] ^ key[keyIndex]);
        }
        
        return result;
    }
}
EOF

    - name: Create build.gradle
      run: |
        cat > build.gradle << 'EOF'
plugins {
    id 'java-library'
}

group = 'jadx.plugins'
version = '1.0.0'

repositories {
    mavenCentral()
    maven { url 'https://jitpack.io' }
}

dependencies {
    implementation 'com.github.skylot:jadx:1.4.7'
    // 添加必要的依赖
    compileOnly 'com.github.skylot:jadx-core:1.4.7'
    compileOnly 'com.github.skylot:jadx-api:1.4.7'
    compileOnly 'com.github.skylot:jadx-plugins-api:1.4.7'
}

java {
    sourceCompatibility = JavaVersion.VERSION_11
    targetCompatibility = JavaVersion.VERSION_11
}

jar {
    manifest {
        attributes(
            'Implementation-Title': project.name,
            'Implementation-Version': project.version,
            'Main-Class': 'jadx.plugins.decryptstrings.StringDecryptPlugin'
        )
    }
}
EOF

    - name: Create settings.gradle
      run: |
        cat > settings.gradle << 'EOF'
rootProject.name = 'jadx_hl1_decryptor'
EOF

    - name: Build with Gradle
      run: ./gradlew clean build --no-daemon

    - name: Upload Binaries
      uses: actions/upload-artifact@v4.3.0
      with:
        name: jadx_hl1_decryptor
        path: build/libs/
        retention-days: 1
        compression-level: 0
        overwrite: true
